name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # –ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –≤—Ä—É—á–Ω—É—é —á–µ—Ä–µ–∑ GitHub UI

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            echo "========================================"
            echo "üöÄ Starting deployment..."
            echo "========================================"

            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd ${{ secrets.PROJECT_PATH || '/root/helmitex_warehouse' }}

            echo "üì• Pulling latest code from main branch..."
            git fetch origin
            git reset --hard origin/main

            echo "üì¶ Checking Docker and Docker Compose..."
            docker --version
            docker compose version || docker-compose --version

            echo "üõë Stopping current containers..."
            docker compose down || docker-compose down || true

            echo "üèóÔ∏è Building Docker images..."
            docker compose build --no-cache || docker-compose build --no-cache

            echo "üöÄ Starting containers..."
            docker compose up -d || docker-compose up -d

            echo "‚è≥ Waiting for services to start..."
            sleep 10

            echo "üîç Checking container status..."
            docker compose ps || docker-compose ps

            echo "üìã Showing recent logs..."
            docker compose logs --tail=50 bot || docker-compose logs --tail=50 bot

            echo "========================================"
            echo "‚úÖ Deployment completed successfully!"
            echo "========================================"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed! Check the logs above."
          exit 1
